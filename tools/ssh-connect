#!/bin/bash

set -e

ScriptVersion="1.0"

ssh_history="$HOME/.ssh_history"

unset ip
unset user
unset passwd
unset port
unset is_sftp

main() {
  init_input_info
  local date=$(date +"%Y%m%d%H%M%S")
  if [ ! $port ]; then
    port=22
  fi
  echo "$ip $user $passwd $port" >>$ssh_history && cat $ssh_history | sort | uniq | sed '/^$/d' >tmp_$date && mv tmp_$date $ssh_history
  cat <<EOF >/tmp/load_ssh.expect
#!/usr/bin/expect
set timeout 30

set ip   [lindex \$argv 0]
set name [lindex \$argv 1]
set pswd [lindex \$argv 2]
set port [lindex \$argv 3]
set ssh  [lindex \$argv 4]
set ssh_port_cmd  [lindex \$argv 5]

spawn \$ssh \$ssh_port_cmd \$port \$name@\$ip
expect {
        "Are you sure you want to continue connecting*"
        {send "yes\n";exp_continue}
        "assword:"
        {send "\$pswd\n"}
}
interact
EOF
  # cmd -> ssh | sftp
  if [ $is_sftp ]; then
    expect /tmp/load_ssh.expect $ip $user $passwd $port sftp -P
  else
    expect /tmp/load_ssh.expect $ip $user $passwd $port ssh -p
  fi
}

init_input_info() {
  if [ ! $ip ] || [ ! $user ] || [ ! $passwd ]; then
    # 没有输入连接信息
    if [ ! -f $ssh_history ]; then # 尝试本地获取历史信息
      echo -e "\033[31m Don't found user configure, Input you're $(basename $0) -i [ip] -u [username] -p [passwd] \033[0m"
      exit
    else
      local line=$(cat "$ssh_history" | wc -l)
      if [ $line -gt 1 ]; then
        echo -e "\033[33m存在多个连接信息：\033[0m"
        echo "SerialNumber Count IP User Port"
        local line_number=0
        while read line; do
          ((line_number++))
          echo $line_number. $line | awk '{print $1,$2,$3,$5}'
        done <"$ssh_history"
        echo -en "\033[33m请选择要连接的目标信息：\033[0m"
        read opt
        if [[ $opt =~ ^[0-9]+$ ]]; then
          ip=$(cat "$ssh_history" | sed -n ${opt}p | awk '{print $1}')
          user=$(cat "$ssh_history" | sed -n ${opt}p | awk '{print $2}')
          passwd=$(cat "$ssh_history" | sed -n ${opt}p | awk '{print $3}')
          port=$(cat "$ssh_history" | sed -n ${opt}p | awk '{print $4}')
        else
          echo -e "\033[31m输入错误，请输入对应的数字序号\033[0m"
          exit
        fi
      else
        ip=$(cat "$ssh_history" | awk '{print $1}')
        user=$(cat "$ssh_history" | awk '{print $2}')
        passwd=$(cat "$ssh_history" | awk '{print $3}')
        port=$(cat "$ssh_history" | awk '{print $4}')
      fi
    fi
  fi
}

usage() {
  echo "Usage :  $(basename "$0") [options] [--] argument-1 argument-2

  Options:
  -h, --help                  Display this message
  -d, --debug                 Debug model run
  -v, --version               Display script version
  -f, --file FILE             Target file
  -D, --directory DIRECTORY   Target directory
  -s, --show user             Show SSH user list
  -i, --ip address            SSH IP address
  -u, --user user             SSH User
  -p, --passwd password       SSH Password
  -P, --port port             SSH connect port"

}

while getopts ":hdvf:D:si:u:p:P:-:" opt; do
  case "${opt}" in
  h) usage && exit 0 ;;
  d) set -x ;;
  v)
    echo "$0 -- Version $ScriptVersion"
    exit
    ;;
  f) file=${OPTARG} ;;
  D) directory=${OPTARG} ;;
  s) cat $ssh_history && exit ;;
  i) ip=${OPTARG} ;;
  u) user=${OPTARG} ;;
  p) passwd=${OPTARG} ;;
  P) port=${OPTARG} ;;
  -) case "${OPTARG}" in
    help) usage && exit 0 ;;
    debug) set -x ;;
    version)
      echo "$0 -- Version $ScriptVersion"
      exit
      ;;
    file)
      file=${!OPTIND}
      OPTIND=$((OPTIND + 1))
      ;;
    directory)
      directory=${!OPTIND}
      OPTIND=$((OPTIND + 1))
      ;;
    ip)
      ip=${!OPTIND}
      OPTIND=$((OPTIND + 1))
      ;;
    user)
      user=${!OPTIND}
      OPTIND=$((OPTIND + 1))
      ;;
    passwd)
      passwd=${!OPTIND}
      OPTIND=$((OPTIND + 1))
      ;;
    sftp)
      is_sftp=1
      OPTIND=$((OPTIND + 1))
      ;;
    *) echo "Invalid option: --${OPTARG}" >&2 && exit 1 ;;
    esac ;;
  :) echo "Option -${OPTARG} requires an argument." >&2 && exit 1 ;;
  *) echo "Invalid option: -${OPTARG}" >&2 && exit 1 ;;
  esac
done
shift $((OPTIND - 1))

main "$@"
