#!/bin/bash

main(){
	adb shell "/data/local/tmp/.bash --version" || install_bash
	person=$(root)
	adb shell "$1" || person=$(user)
	echo $person | base64 -d > /tmp/into_adb_shell.expect && expect /tmp/into_adb_shell.expect
}

install_bash(){
	version="5.2.015-1.2.3-2"

	abi=$(adb shell getprop ro.product.cpu.abi)
	if [ "$abi" == "arm64-v8a" ];then
		abi="aarch64"
	fi

	if [ ! -f "bash-linux-${abi}" ];then
		wget https://github.com/robxu9/bash-static/releases/download/${version}/bash-linux-${abi}
	fi

	adb push bash-linux-${abi} /data/local/tmp/.bash
	adb shell "chmod +x /data/local/tmp/.bash"
	rm bash-linux-${abi}
}


user(){
	echo "IyEvdXNyL2Jpbi9leHBlY3QKCnNldCB0aW1lb3V0IDIKc2V0IHBhdGggIi9kYXRhL2xvY2FsL3RtcCIKc3Bhd24gYWRiIHNoZWxsCgpleHBlY3QgIiokICIge3NlbmQgIiRwYXRoLy5iYXNoXG4ifQpleHBlY3QgIioiIHtzZW5kICJQUzE9J1xcMDMzXFsxOzM3bVxcJCBcXDAzM1xbMG0nXG4ifQpleHBlY3QgIiQgIiB7c2VuZCAiZXhwb3J0IEhPTUU9JHBhdGhcbiJ9CmV4cGVjdCAiJCAiIHtzZW5kICJhbGlhcyBjbD1jbGVhclxuIn0KZXhwZWN0ICIkICIge3NlbmQgImFsaWFzIGxzPSdscyAtLWNvbG9yJ1xuIn0KZXhwZWN0ICIkICIge3NlbmQgImFsaWFzIGxsPSdscyAtbEZoIC0tY29sb3InXG4ifQpleHBlY3QgIiQgIiB7c2VuZCAiYWxpYXMgZHU9J2R1IC1zaCdcbiJ9CmV4cGVjdCAiJCAiIHtzZW5kICJjZCYmY2wmJnB3ZFxuIn0KCmludGVyYWN0Cg=="
	#echo "IyEvdXNyL2Jpbi9leHBlY3QKCnNldCB0aW1lb3V0IDIKc2V0IHBhdGggIi9kYXRhL2xvY2FsL3RtcCIKc3Bhd24gYWRiIHNoZWxsCgpleHBlY3QgIiokICIge3NlbmQgImNkICRwYXRoXG4ifQpleHBlY3QgIiokcGF0aCAkICIge3NlbmQgImlkXG4ifQpleHBlY3QgIiokcGF0aCAkICIge3NlbmQgIlBTMT0nJCAnXG4ifQpleHBlY3QgIiQgIiB7c2VuZCAiYWxpYXMgY2w9Y2xlYXJcbiJ9CmV4cGVjdCAiJCAiIHtzZW5kICJhbGlhcyBscz0nbHMgLS1jb2xvcidcbiJ9CmV4cGVjdCAiJCAiIHtzZW5kICJhbGlhcyBsbD0nbHMgLWxGaCAtLWNvbG9yJ1xuIn0KZXhwZWN0ICIkICIge3NlbmQgImFsaWFzIGR1PSdkdSAtc2gnXG4ifQpleHBlY3QgIiQgIiB7c2VuZCAiY2wmJnB3ZFxuIn0KCmludGVyYWN0Cg=="
}

root(){
	echo "IyEvdXNyL2Jpbi9leHBlY3QKCnNldCB0aW1lb3V0IDIKc2V0IHBhdGggIi9kYXRhL2xvY2FsL3RtcCIKc3Bhd24gYWRiIHNoZWxsCgpleHBlY3QgIiokICIge3NlbmQgInN1XG4ifQpleHBlY3QgIiojICIge3NlbmQgIiRwYXRoLy5iYXNoXG4ifQpleHBlY3QgIioiIHtzZW5kICJQUzE9J1xcMDMzXFsxOzM3bVxcJCBcXDAzM1xbMG0nXG4ifQpleHBlY3QgIioiIHtzZW5kICJleHBvcnQgSE9NRT0kcGF0aFxuIn0KZXhwZWN0ICIqIiB7c2VuZCAiYWxpYXMgY2w9Y2xlYXJcbiJ9CmV4cGVjdCAiKiIge3NlbmQgImFsaWFzIGxzPSdscyAtLWNvbG9yJ1xuIn0KZXhwZWN0ICIqIiB7c2VuZCAiYWxpYXMgbGw9J2xzIC1sRmggLS1jb2xvcidcbiJ9CmV4cGVjdCAiKiIge3NlbmQgImFsaWFzIGR1PSdkdSAtc2gnXG4ifQpleHBlY3QgIioiIHtzZW5kICJjZCYmY2wmJnB3ZFxuIn0KCmludGVyYWN0Cg==" 
	#echo "IyEvdXNyL2Jpbi9leHBlY3QKCnNldCB0aW1lb3V0IDIKc2V0IHBhdGggIi9kYXRhL2xvY2FsL3RtcCIKc3Bhd24gYWRiIHNoZWxsCgpleHBlY3QgIiokICIge3NlbmQgInN1XG4ifQpleHBlY3QgIiojICIge3NlbmQgImNkICRwYXRoXG4ifQpleHBlY3QgIiojICIge3NlbmQgIi4vYmFzaFxuIn0KZXhwZWN0ICIqIiB7c2VuZCAiUFMxPScjICdcbiJ9CmV4cGVjdCAiKiIge3NlbmQgImFsaWFzIGNsPWNsZWFyXG4ifQpleHBlY3QgIioiIHtzZW5kICJhbGlhcyBscz0nbHMgLS1jb2xvcidcbiJ9CmV4cGVjdCAiKiIge3NlbmQgImFsaWFzIGxsPSdscyAtbEZoIC0tY29sb3InXG4ifQpleHBlY3QgIioiIHtzZW5kICJhbGlhcyBkdT0nZHUgLXNoJ1xuIn0KZXhwZWN0ICIqIiB7c2VuZCAiY2wmJnB3ZFxuIn0KCmludGVyYWN0Cg=="
	#Update -> PS1 : #
	#echo "IyEvdXNyL2Jpbi9leHBlY3QKCnNldCB0aW1lb3V0IDIKc2V0IHBhdGggIi9kYXRhL2xvY2FsL3RtcCIKc3Bhd24gYWRiIHNoZWxsCgpleHBlY3QgIiokICIge3NlbmQgInN1XG4ifQpleHBlY3QgIiojICIge3NlbmQgImNkICRwYXRoXG4ifQpleHBlY3QgIiojICIge3NlbmQgIi4vYmFzaFxuIn0KZXhwZWN0ICIqIiB7c2VuZCAiaWRcbiJ9CmV4cGVjdCAiKiIge3NlbmQgImFsaWFzIGNsPWNsZWFyXG4ifQpleHBlY3QgIioiIHtzZW5kICJhbGlhcyBscz0nbHMgLS1jb2xvcidcbiJ9CmV4cGVjdCAiKiIge3NlbmQgImFsaWFzIGxsPSdscyAtbEZoIC0tY29sb3InXG4ifQpleHBlY3QgIioiIHtzZW5kICJhbGlhcyBkdT0nZHUgLXNoJ1xuIn0KZXhwZWN0ICIqIiB7c2VuZCAiY2wmJnB3ZFxuIn0KCmludGVyYWN0Cg=="
}

current_divece_id=$(adb devices | grep "device\$" | awk '{print $1}')
if [ "$current_divece_id" == "MPS0123811000255" ];then #这个设备比较特殊，进入shell默认就是root
	echo $(root) | base64 -d > /tmp/into_adb_shell.expect && expect /tmp/into_adb_shell.expect
else
	main "su -c 'id'"
fi
